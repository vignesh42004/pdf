name: Auto Post PDF to Blogger

on:
  push:
    paths:
      - '**.pdf'

jobs:
  post-to-blogger:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Find new PDF and post to Blogger
        run: |
          # Get list of added PDF files
          PDF_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep -i '\.pdf$' || true)
          
          if [ -z "$PDF_FILES" ]; then
            echo "No new PDF files found"
            exit 0
          fi
          
          # Process each PDF
          echo "$PDF_FILES" | while IFS= read -r PDF_FILE; do
            if [ -z "$PDF_FILE" ]; then
              continue
            fi
            
            echo "Processing: $PDF_FILE"
            
            # Get PDF name (without extension)
            PDF_NAME=$(basename "$PDF_FILE" .pdf)
            
            # URL encode the file path
            PDF_URL_PATH=$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$PDF_FILE")
            PDF_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${PDF_URL_PATH}"
            
            echo "Title: $PDF_NAME"
            echo "URL: $PDF_URL"
            
            # Get access token
            TOKEN_RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
              -d "client_id=${{ secrets.BLOGGER_CLIENT_ID }}" \
              -d "client_secret=${{ secrets.BLOGGER_CLIENT_SECRET }}" \
              -d "refresh_token=${{ secrets.BLOGGER_REFRESH_TOKEN }}" \
              -d "grant_type=refresh_token")
            
            ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
            
            if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
              echo "‚ùå Failed to get access token"
              echo "$TOKEN_RESPONSE"
              exit 1
            fi
            
            # Create post content
            CONTENT="<div style=\"background: rgb(255, 248, 225); border-radius: 8px; border: 1px solid rgb(255, 204, 2); color: #6d5c00; font-size: 13px; margin: 15px 0px; padding: 15px;\"><strong>üìÑ Document Disclaimer:</strong> This PDF is shared for educational purposes only. We do not own the copyright. If you are the owner and want it removed, please contact us.</div><blockquote style=\"background: #f0f7ff; border-left: 4px solid #3498db; margin: 15px 0; padding: 12px 15px; border-radius: 0 8px 8px 0;\"><p style=\"margin: 0;\"><strong>üí° Pro Tip:</strong> Use Refresh button if not visible and try full screen mode for better view.</p></blockquote><style>.modern-pdf-wrap{position:relative;max-width:900px;margin:20px auto;border-radius:12px;overflow:hidden;box-shadow:0 5px 25px rgba(0,0,0,0.2);width:95%}.modern-pdf-frame{width:100%;height:620px;border:none;display:block}.floating-controls{position:absolute;top:15px;right:15px;z-index:100;display:flex;gap:10px}.float-btn{width:45px;height:45px;border-radius:50%;border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(0,0,0,0.3);color:white}.float-btn:hover{transform:scale(1.15)}.refresh-btn{background:#3498db}.fullscreen-btn{background:#27ae60}.download-btn{background:#9b59b6;text-decoration:none}@media(max-width:768px){.modern-pdf-wrap{margin:10px auto;border-radius:8px}.modern-pdf-frame{height:450px}.float-btn{width:40px;height:40px;font-size:16px}}@media(max-width:480px){.modern-pdf-wrap{width:100%;margin:5px auto;border-radius:0}.modern-pdf-frame{height:400px}.float-btn{width:36px;height:36px;font-size:14px}}</style><div class=\"modern-pdf-wrap\"><div class=\"floating-controls\"><button class=\"float-btn refresh-btn\" onclick=\"refreshPDF()\" title=\"Refresh\">‚Üª</button><button class=\"float-btn fullscreen-btn\" onclick=\"fullscreenPDF()\" title=\"Fullscreen\">‚õ∂</button><a class=\"float-btn download-btn\" href=\"${PDF_URL}\" target=\"_blank\" download title=\"Download\">‚¨á</a></div><iframe id=\"modernPdfViewer\" class=\"modern-pdf-frame\" src=\"https://docs.google.com/viewer?url=${PDF_URL}&embedded=true\" allowfullscreen></iframe></div><script>function fullscreenPDF(){var el=document.getElementById('modernPdfViewer');if(el.requestFullscreen){el.requestFullscreen()}else if(el.webkitRequestFullscreen){el.webkitRequestFullscreen()}else if(el.msRequestFullscreen){el.msRequestFullscreen()}}function refreshPDF(){var el=document.getElementById('modernPdfViewer');el.src=el.src}</script>"
            
            # Create JSON payload
            jq -n \
              --arg title "$PDF_NAME" \
              --arg content "$CONTENT" \
              '{kind: "blogger#post", title: $title, content: $content}' > post.json
            
            # Post to Blogger
            RESPONSE=$(curl -s -X POST \
              "https://www.googleapis.com/blogger/v3/blogs/${{ secrets.BLOGGER_BLOG_ID }}/posts/" \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              -d @post.json)
            
            POST_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
            
            if [ -n "$ERROR" ]; then
              echo "‚ùå Error: $ERROR"
              exit 1
            fi
            
            if [ -n "$POST_URL" ]; then
              echo "‚úÖ Posted: $POST_URL"
            else
              echo "‚ùå Failed to post"
              echo "$RESPONSE"
              exit 1
            fi
            
          done
